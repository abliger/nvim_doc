<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="IE=edge" http-equiv="X-UA-Compatible">
  <meta name="description" content="vim out of the box">
  <meta content="width=device-width, initial-scale=1" name="viewport">
  <title>Nvim 文档: usr_11</title>
  <link href="https://fonts.googleapis.com/css?family=Lato:400,700,900" rel="stylesheet">
  <link href="../css/normalize.min.css" rel="stylesheet">
  <link href="../css/bootstrap.css" rel="stylesheet">
  <link href="../css/main.css" rel="stylesheet">
  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>
  <header class="container">
    <nav class="navbar navbar-expand-lg">
      <div class="container-fluid">
        <a href="/" class="navbar-brand" aria-label="logo">
          <svg xmlns="http://www.w3.org/2000/svg" role="img" width="173" height="50" viewBox="0 0 742 214"
            aria-label="Neovim">
            <title>Neovim</title>
            <defs>
              <linearGradient x1="50%" y1="0%" x2="50%" y2="100%" id="a">
                <stop stop-color="#16B0ED" stop-opacity=".8" offset="0%" />
                <stop stop-color="#0F59B2" stop-opacity=".837" offset="100%" />
              </linearGradient>
              <linearGradient x1="50%" y1="0%" x2="50%" y2="100%" id="b">
                <stop stop-color="#7DB643" offset="0%" />
                <stop stop-color="#367533" offset="100%" />
              </linearGradient>
              <linearGradient x1="50%" y1="0%" x2="50%" y2="100%" id="c">
                <stop stop-color="#88C649" stop-opacity=".8" offset="0%" />
                <stop stop-color="#439240" stop-opacity=".84" offset="100%" />
              </linearGradient>
            </defs>
            <g fill="none" fill-rule="evenodd">
              <path d="M.027 45.459L45.224-.173v212.171L.027 166.894V45.459z" fill="url(#a)"
                transform="translate(1 1)" />
              <path d="M129.337 45.89L175.152-.149l-.928 212.146-45.197-45.104.31-121.005z" fill="url(#b)"
                transform="matrix(-1 0 0 1 305 1)" />
              <path d="M45.194-.137L162.7 179.173l-32.882 32.881L12.25 33.141 45.194-.137z" fill="url(#c)"
                transform="translate(1 1)" />
              <path d="M46.234 84.032l-.063 7.063-36.28-53.563 3.36-3.422 32.983 49.922z" fill-opacity=".13"
                fill="#000" />
              <g fill="#444">
                <path
                  d="M227 154V64.44h4.655c1.55 0 2.445.75 2.685 2.25l.806 13.502c4.058-5.16 8.786-9.316 14.188-12.466 5.4-3.15 11.413-4.726 18.037-4.726 4.893 0 9.205.781 12.935 2.34 3.729 1.561 6.817 3.811 9.264 6.751 2.448 2.942 4.297 6.48 5.55 10.621 1.253 4.14 1.88 8.821 1.88 14.042V154h-8.504V96.754c0-8.402-1.91-14.987-5.729-19.757-3.82-4.771-9.667-7.156-17.544-7.156-5.851 0-11.28 1.516-16.292 4.545-5.013 3.032-9.489 7.187-13.427 12.467V154H227zM350.624 63c5.066 0 9.755.868 14.069 2.605 4.312 1.738 8.052 4.268 11.219 7.592s5.638 7.412 7.419 12.264C385.11 90.313 386 95.883 386 102.17c0 1.318-.195 2.216-.588 2.696-.393.48-1.01.719-1.851.719h-64.966v1.70c0 6.708.784 12.609 2.353 17.7 1.567 5.09 3.8 9.357 6.695 12.802 2.895 3.445 6.393 6.034 10.495 7.771 4.1 1.738 8.686 2.606 13.752 2.606 4.524 0 8.446-.494 11.762-1.483 3.317-.988 6.108-2.097 8.37-3.324 2.261-1.227 4.056-2.336 5.383-3.324 1.326-.988 2.292-1.482 2.895-1.482.784 0 1.388.3 1.81.898l2.352 2.875c-1.448 1.797-3.362 3.475-5.745 5.031-2.383 1.558-5.038 2.891-7.962 3.998-2.926 1.109-6.062 1.991-9.41 2.65a52.21 52.21 0 01-10.088.989c-6.152 0-11.762-1.064-16.828-3.19-5.067-2.125-9.415-5.225-13.043-9.298-3.63-4.074-6.435-9.06-8.415-14.96C310.99 121.655 310 114.9 310 107.294c0-6.408.92-12.323 2.76-17.744 1.84-5.421 4.493-10.093 7.961-14.016 3.467-3.922 7.72-6.991 12.758-9.209C338.513 64.11 344.229 63 350.624 63zm.573 6c-4.696 0-8.904.702-12.623 2.105-3.721 1.404-6.936 3.421-9.65 6.053-2.713 2.631-4.908 5.79-6.586 9.474S319.55 94.439 319 99h60c0-4.679-.672-8.874-2.013-12.588-1.343-3.712-3.232-6.856-5.67-9.43-2.44-2.571-5.367-4.545-8.782-5.92-3.413-1.374-7.192-2.062-11.338-2.062zM435.546 63c6.526 0 12.368 1.093 17.524 3.28 5.154 2.186 9.5 5.286 13.04 9.298 3.538 4.013 6.238 8.85 8.099 14.51 1.861 5.66 2.791 11.994 2.791 19.002 0 7.008-.932 13.327-2.791 18.957-1.861 5.631-4.561 10.452-8.099 14.465-3.54 4.012-7.886 7.097-13.04 9.254-5.156 2.156-10.998 3.234-17.524 3.234-6.529 0-12.369-1.078-17.525-3.234-5.155-2.157-9.517-5.242-13.085-9.254-3.57-4.013-6.285-8.836-8.145-14.465-1.861-5.63-2.791-11.95-2.791-18.957 0-7.008.93-13.342 2.791-19.002 1.861-5.66 4.576-10.496 8.145-14.51 3.568-4.012 7.93-7.112 13.085-9.299C423.177 64.094 429.017 63 435.546 63zm-.501 86c5.341 0 10.006-.918 13.997-2.757 3.99-1.838 7.32-4.474 9.992-7.909 2.67-3.435 4.664-7.576 5.986-12.428 1.317-4.85 1.98-10.288 1.98-16.316 0-5.965-.66-11.389-1.98-16.27-1.322-4.88-3.316-9.053-5.986-12.519-2.67-3.463-6-6.13-9.992-7.999-3.991-1.867-8.657-2.802-13.997-2.802s-10.008.935-13.997 2.802c-3.991 1.87-7.322 4.536-9.992 8-2.671 3.465-4.68 7.637-6.03 12.518-1.35 4.881-2.026 10.305-2.026 16.27 0 6.026.675 11.465 2.025 16.316 1.35 4.852 3.36 8.993 6.031 12.428 2.67 3.435 6 6.07 9.992 7.91 3.99 1.838 8.656 2.756 13.997 2.756z"
                  fill="currentColor" />
                <path
                  d="M530.57 152h-20.05L474 60h18.35c1.61 0 2.967.39 4.072 1.166 1.103.778 1.865 1.763 2.283 2.959l17.722 49.138a92.762 92.762 0 012.551 8.429c.686 2.751 1.298 5.5 1.835 8.25.537-2.75 1.148-5.499 1.835-8.25a77.713 77.713 0 012.64-8.429l18.171-49.138c.417-1.196 1.164-2.181 2.238-2.96 1.074-.776 2.356-1.165 3.849-1.165H567l-36.43 92zM572 61h23v92h-23zM610 153V60.443h13.624c2.887 0 4.78 1.354 5.682 4.06l1.443 6.856a52.7 52.7 0 015.097-4.962 32.732 32.732 0 015.683-3.879 30.731 30.731 0 016.496-2.57c2.314-.632 4.855-.948 7.624-.948 5.832 0 10.63 1.579 14.39 4.736 3.758 3.157 6.57 7.352 8.434 12.585 1.444-3.068 3.248-5.698 5.413-7.894 2.165-2.194 4.541-3.984 7.127-5.367a32.848 32.848 0 018.254-3.068 39.597 39.597 0 018.796-.992c5.111 0 9.653.783 13.622 2.345 3.97 1.565 7.307 3.849 10.014 6.857 2.706 3.007 4.766 6.675 6.18 11.005C739.29 83.537 740 88.5 740 94.092V153h-22.284V94.092c0-5.894-1.294-10.329-3.878-13.306-2.587-2.977-6.376-4.465-11.368-4.465-2.286 0-4.404.391-6.358 1.172a15.189 15.189 0 00-5.144 3.383c-1.473 1.474-2.631 3.324-3.474 5.548-.842 2.225-1.263 4.781-1.263 7.668V153h-22.37V94.092c0-6.194-1.249-10.704-3.744-13.532-2.497-2.825-6.18-4.24-11.051-4.24-3.19 0-6.18.798-8.976 2.391-2.799 1.593-5.399 3.775-7.804 6.54V153H610zM572 30h23v19h-23z"
                  fill="currentColor" fill-opacity=".8" />
              </g>
            </g>
          </svg>
        </a>
      </div>
    </nav>
  </header>

  <div class="container">
    <h1>Nvim 文档: usr_11</h1>
    <A NAME="top"></A>
    <A HREF="index.html">主帮助文件</A>

    <HR>
    <PRE>

*<A NAME="usr_11.txt"></A><B>usr_11.txt</B>*	Nvim

		     VIM用户手册 - by Bram Moolenaar

			   从崩溃中恢复


你的计算机崩溃过吗？是不是还正好在你编辑了几个小时以后？不要惊慌！Vim 已经保存了大部分的信息使你可以恢复你的大多数数据。本章告诉你怎样恢复这些数据并向你介绍Vim 是如何使用交换文件的.

|<A HREF="#11.1">11.1</A>|	基础的<A HREF="recover.html#recovery">恢复</A>
|<A HREF="#11.2">11.2</A>|	交换文件在哪里?
|<A HREF="#11.3">11.3</A>|	有没有崩溃
|<A HREF="#11.4">11.4</A>|	深入阅读

下一章: |<A HREF="usr_12.html">usr_12.txt</A>|  小技巧
上一章: |<A HREF="usr_10.html">usr_10.txt</A>|  做大改变
目录:   |<A HREF="usr_toc.html">usr_toc.txt</A>|

==============================================================================

*<A NAME="11.1"></A><B>11.1</B>*	基础的<A HREF="recover.html#recovery">恢复</A>

大多数情况恢复文件是比较简单的，假设你知道正在编辑的是哪个文件 (并且硬盘没坏的话)。可以用&quot;<A HREF="starting.html#-r">-r</A>&quot;选项启动:

<B>	vim -r help.txt</B>

Vim 会读取交换文件 (用于保存你的编辑数据的文件) 并且提取原文的编辑碎片。如果Vim 恢复了你的改变，你会看到如下文字 (当然了，文件名会不一样):

<B><FONT color="#3A6F2B">	Using swap file ".help.txt.swp" </FONT></B>
<B><FONT color="#3A6F2B">	Original file "~/vim/runtime/doc/help.txt" </FONT></B>
<B><FONT color="#3A6F2B">	Recovery completed. You should check if everything is OK. </FONT></B>
<B><FONT color="#3A6F2B">	(You might want to write out this file under another name </FONT></B>
<B><FONT color="#3A6F2B">	and run diff with the original file to check for changes) </FONT></B>
<B><FONT color="#3A6F2B">	You may want to delete the .swp file now. </FONT></B>

为了安全起见，可以用另一个文件名保存这个文件:

<B>	:write help.txt.recovered</B>

可以把这个文件与原文件作一下比较，看看恢复的效果如何。这方面 Vimdiff 可以帮很大的忙,见|<A HREF="usr_08.html#08.7">08.7</A>|.例如:

<B>	:write help.txt.recovered</B>
<B>	:edit #</B>
<B>	:diffsp help.txt</B>

注意用一个比较新的原文件来比较 (你在计算机崩溃前最后保存过的文件)，并且检查有没有东西丢失了 (由于某些问题导致 Vim 无法恢复)。如果在恢复的过程中 Vim 显示出一些警告信息，注意小心阅读。这应该是很少见的。
如果恢复产生的文件和文件内容完全一致，你会看到以下消息:

<B><FONT color="#3A6F2B">	Using swap file ".help.txt.swp" </FONT></B>
<B><FONT color="#3A6F2B">	Original file "~/vim/runtime/doc/help.txt" </FONT></B>
<B><FONT color="#3A6F2B">	Recovery completed. Buffer contents equals file contents. </FONT></B>
<B><FONT color="#3A6F2B">	You may want to delete the .swp file now. </FONT></B>

通常这是因为你已经恢复过改变，或者修改后写入了文件。此时删除交换文件应该安全。

最后所做的一些修改不能恢复是正常的。Vim 在你停止大约 4 秒不输入的时候或者输入大约两百个字符以后才会更新交换文件。这间可以通过 'updatetime' 和 'updatecount'两个选项来调整。这样，如果系统崩溃前 Vim 没有更新交换文件，最后一次更新后编辑的内容就会丢失。

如果你编辑的时候没有给定文件名，可以用一个空的字符串来表示文件名:

<B>	vim -r ""</B>

你需要进入原来的目录执行这个命令，否则 Vim 是找不到这个交换文件的

==============================================================================

*<A NAME="11.2"></A><B>11.2</B>*	交换文件在哪里?

Vim 可以把交换文件保存在几个不同的地方。通常是原文件所在的目录。要知道这一点,进入该目录，然后输入:

<B>	vim -r</B>

Vim 会列出所有它能找到的交换文件。它还会从其它目录寻找本目录文件的交换文件，但它不会寻找其它目录里的交换文件，更不会遍及整个目录树。
这个命令的输出如下:

<B><FONT color="#3A6F2B">	Swap files found: </FONT></B>
<B><FONT color="#3A6F2B">	   In current directory: </FONT></B>
<B><FONT color="#3A6F2B">	1.    .main.c.swp </FONT></B>
<B><FONT color="#3A6F2B">		  owned by: mool   dated: Tue May 29 21:00:25 2001 </FONT></B>
<B><FONT color="#3A6F2B">		 file name: ~mool/vim/vim6/src/main.c </FONT></B>
<B><FONT color="#3A6F2B">		  modified: YES </FONT></B>
<B><FONT color="#3A6F2B">		 user name: mool   host name: masaka.moolenaar.net </FONT></B>
<B><FONT color="#3A6F2B">		process ID: 12525 </FONT></B>
<B><FONT color="#3A6F2B">	   In directory ~/tmp: </FONT></B>
<B><FONT color="#3A6F2B">	      -- none -- </FONT></B>
<B><FONT color="#3A6F2B">	   In directory /var/tmp: </FONT></B>
<B><FONT color="#3A6F2B">	      -- none -- </FONT></B>
<B><FONT color="#3A6F2B">	   In directory /tmp: </FONT></B>
<B><FONT color="#3A6F2B">	      -- none -- </FONT></B>

如果有几个交换文件，其中一个可能是你要的，Vim 会给出一个文件列表，你需要输入一个表示这个文件的数字。小心检查那几个文件的时间，并确定哪一个才是你需要的。
万一你不知道是哪个的话，一个一个试一试。

使用特定的交换文件

如果你知道要用哪个文件，你可以指定交换文件的名字。Vim 会找出交换文件所对应的原始文件的名字。

例如:
<B>	vim -r .help.txt.swo</B>

这个方法在交换文件在一个非预期的目录中时很有用。Vim 知道 *.s[uvw][a-z] 模式的文件是交换文件。

如果这还不行，看看 Vim 报告的文件名是什么，然后根据需要给文件换名。根据'directory' 选项的值你可以知道 Vim 会把交换文件放到什么地方。

备注:
Vim 在 'dir' 选项指定的目录中寻找名为 "filename.sw?" 的交换文件。如果通配符不能正常工作 (例如 'shell' 选项不正确)，Vim 转而尝试文件"filename.swp"。如果仍失败，你就只能通过给定交换文件的名称来恢复原来的文件了。

==============================================================================

*<A NAME="11.3"></A><B>11.3</B>*	有没有崩溃					*<A NAME="ATTENTION"></A><B>ATTENTION</B>* *<A NAME="E325"></A><B>E325</B>*

Vim 尽可能保护你不要做傻事。有时你打开一个文件，天真地以为文件的内容会显示出来。可是，Vim 却给出一段很长的信息:

<B><FONT color="#3A6F2B">		E325: ATTENTION </FONT></B>
<B><FONT color="#3A6F2B">	Found a swap file by the name ".main.c.swp" </FONT></B>
<B><FONT color="#3A6F2B">		  owned by: mool   dated: Tue May 29 21:09:28 2001 </FONT></B>
<B><FONT color="#3A6F2B">		 file name: ~mool/vim/vim6/src/main.c </FONT></B>
<B><FONT color="#3A6F2B">		  modified: no </FONT></B>
<B><FONT color="#3A6F2B">		 user name: mool   host name: masaka.moolenaar.net </FONT></B>
<B><FONT color="#3A6F2B">		process ID: 12559 (still running) </FONT></B>
<B><FONT color="#3A6F2B">	While opening file "main.c" </FONT></B>
<B><FONT color="#3A6F2B">		     dated: Tue May 29 19:46:12 2001 </FONT></B>
<B><FONT color="#3A6F2B"> </FONT></B>
<B><FONT color="#3A6F2B">	(1) Another program may be editing the same file. </FONT></B>
<B><FONT color="#3A6F2B">	    If this is the case, be careful not to end up with two </FONT></B>
<B><FONT color="#3A6F2B">	    different instances of the same file when making changes. </FONT></B>
<B><FONT color="#3A6F2B">	    Quit, or continue with caution. </FONT></B>
<B><FONT color="#3A6F2B"> </FONT></B>
<B><FONT color="#3A6F2B">	(2) An edit session for this file crashed. </FONT></B>
<B><FONT color="#3A6F2B">	    If this is the case, use ":recover" or "vim -r main.c" </FONT></B>
<B><FONT color="#3A6F2B">	    to recover the changes (see ":help recovery"). </FONT></B>
<B><FONT color="#3A6F2B">	    If you did this already, delete the swap file ".main.c.swp" </FONT></B>
<B><FONT color="#3A6F2B">	    to avoid this message. </FONT></B>

你遇到这个信息是因为 Vim 发现你编辑的文件的交换文件已经存在。这一定是有什么地方出问题了。可能的原因有两个:

1. 这个文件正在被另一个进程编辑。注意有 "process ID" 那行。它看起来是这样的:

<B><FONT color="#3A6F2B">		process ID: 12559 (still running) </FONT></B>

    "still running" 表示同一台计算机上有一个进程正在编辑这个文件。在非 Unix 的
    系统上你不会得到这个信息。而如果你通过网络编辑这个文件，可能也得不到这个信
    息，因为那个进程不在你的机器上。在这两种情况下，你要自己找到原因。
    如果另一个 Vim 正在编辑这个文件，继续编辑会导致同一个文件有两个版本。最
    后存盘的文件会覆盖前一个版本。这样的结果是一些编辑数据丢失了。这种情况下，
    你最好退出这个 Vim。
    
    2. 交换文件可能是由于前一次 Vim 或者计算机崩溃导致的。检查提示信息中的日期。如
    果交换文件比你正在编辑的文件新，而且出现这个信息:

<B><FONT color="#3A6F2B">		modified: YES </FONT></B>

    这就表明你很可能需要恢复了。
    如果文件的日期比交换文件新，可能是在崩溃后被修改过了 (也许你已经恢复
    过，只是没有删除交换文件？)，也可能文件在崩溃前保存过，但这发生在在最后一次
    写入该交换文件之后 (那你运气了，你根本不需要这个旧的交换文件)。Vim 会用如下
    语句提醒你:


<B><FONT color="#3A6F2B">      NEWER than swap file! </FONT></B>


备注 在下面情形下，Vim 知道交换文件没有用了，会自动删除它:
- 文件是合法的交换文件 (魔术数正确)。
- 文件修改过的标志位未置位。
- 进程不在运行。

可以用|<A HREF="autocmd.html#FileChangedShell">FileChangedShell</A>|<A HREF="autocmd.html#autocommand">自动命令</A>事件来编程处理这种情况。

<B><FONT color="#3A6F2B">无法读取的交换文件</FONT></B>

有时下面这样的信息

<B><FONT color="#3A6F2B">	[cannot be read] </FONT></B>

会出现在交换文件的文件名之下。这可好可坏，依情况而定。

如果上次编辑在作出任何修改前就崩溃了的话，是好事。这样交换文件的长度为 0。你只要删除之然后继续即可。

如果情况是你对交换文件没有读权限，就比较糟糕。你可能得以只读方式浏览该文件。或者退出。在多用户系统中，如果你以别人的身份登录并做了上一次修改，先退出登录然后以那个身份重新登录可能会 "治愈" 该读取错误。不然的话，你得找出是谁做的上一次修改 (或正在修改)，然后和那个人聊聊。

如果情况是交换文件所在的磁盘物理性地损坏了，就非常糟糕了。幸运的是，这种情况几乎不会发生。你可能需要以只读方式查看文件 (如果允许的话)，看看到底有多少改动被 "忘记" 了。如果你是改动文件的那个人，准备好重做你的改动。


怎么办?					*<A NAME="swap-exists-choices"></A><B>swap-exists-choices</B>*

如果 Vim 版本支持对话框，你可以从对话框的六个选择中挑一个:

<B><FONT color="#3A6F2B">  Swap file ".main.c.swp" already exists! </FONT></B>
<B><FONT color="#3A6F2B">  [O]pen Read-Only, (E)dit anyway, (R)ecover, (Q)uit, (A)bort, (D)elete it: </FONT></B>

O 用只读方式打开文件。当你只是想看看文件的内容，而不打算恢复它的时候用这个选
项。你可能知道有人在编辑它，但你想看看它的内容，而不会修改它。

E 直接编辑。小心使用这个选择！如果这个文件已经被另一个文件打开，你编辑它会导
致它有两个版本。Vim 已经警告过你了，安全比事后说对不起要好。

R 从交换文件中恢复文件。如果你知道交换文件中有新的东西，而你想恢复它，选择这
一项。

Q 退出。不再编辑该文件。在有另一个 Vim 编辑该文件的时候选这一项。
如果你刚打开 Vim，这会退出 Vim。当你用多个窗口打开几个文件，Vim 只会在
第一个文件遇到交换文件的时候退出。如果你是通过编辑命令打开文件，该文件不会
被载入，Vim 会回到原来的文件中。

A 中止。类似 (Q) 退出，但同时中止更多的命令。这在试图加载一个编辑多个文件的脚
本 (例如一个多窗口的会话) 时很有用。

D 删除交换文件。当你能确定你不再需要它的时候选这一项。例如，它不包括修改的数
据，或者你的文件比交换文件新。
在 Unix 系统上，只有建立这个交换文件的进程不再运行，这个选择才会出现。

如果没有出现对话框 (你使用的 Vim 不支持对话框)，你只能手工处理。要恢复一个文
件，使用如下命令:

<B>	:recover</B>


Vim 不是总能检测到一个文件有交换文件的。当另一个会话把交换文件放到别的位置或者
在编辑另一台机器的文件的时候，双方使用的交换文件路径不一样都会发生这个问题。所
以，不要老是等 Vim 来提醒你。

如果你确实不想看到这个信息，你可以在 'shortmess' 选项中加上 'A' 标志位。不过一
般你不需要这样做。

关于加密和交换文件关系的注释，见 :recover-crypt 。
要通过程序访问交换文件，见 swapinfo() 。

==============================================================================

*<A NAME="11.4"></A><B>11.4</B>*	深入阅读

|<A HREF="recover.html#swap-file">swap-file</A>|	解释交换文件在什么地方创建以及名字是什么。
|<A HREF="recover.html#:preserve">:preserve</A>|	手工刷新交换文件
|<A HREF="recover.html#:swapname">:swapname</A>|	查看当前文件的交换文件
<A HREF="options.html#'updatecount'">'updatecount'</A>  多少个键被敲下后执行一次交换文件刷新
<A HREF="options.html#'updatetime'">'updatetime'</A>	交换文件刷新后的超时时间
<A HREF="options.html#'directory'">'directory'</A>	列出用于保存交换文件的目录

==============================================================================

下一章: |<A HREF="usr_12.html">usr_12.txt</A>|  小技巧
<A HREF="#top">top</A> - <A HREF="index.html">主帮助文件</A>
</PRE>
  </div>
</body>

</html>